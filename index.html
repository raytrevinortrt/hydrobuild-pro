<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HydroBuild Pro - Professional Irrigation Design</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: #0a1612;
      color: #e0e0e0;
      overflow-x: hidden;
    }
    
    #root {
      min-height: 100vh;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback } = React;

    // Icon components
    const Droplet = ({size = 24, ...props}) => <svg {...props} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>;
    const Plus = ({size = 24, ...props}) => <svg {...props} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
    const ChevronRight = ({size = 24, ...props}) => <svg {...props} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"/></svg>;
    const ChevronLeft = ({size = 24, ...props}) => <svg {...props} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"/></svg>;
    const X = ({size = 24, ...props}) => <svg {...props} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
    const Check = ({size = 24, ...props}) => <svg {...props} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>;
    const Zap = ({size = 24, ...props}) => <svg {...props} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>;
    const FileText = ({size = 24, ...props}) => <svg {...props} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>;
    const Download = ({size = 24, ...props}) => <svg {...props} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
    const Move = ({size = 24, ...props}) => <svg {...props} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="15 19 12 22 9 19"/><polyline points="19 9 22 12 19 15"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="2" x2="12" y2="22"/></svg>;
    const Trash = ({size = 24, ...props}) => <svg {...props} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>;
    const AlertCircle = ({size = 24, ...props}) => <svg {...props} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>;
    const Activity = ({size = 24, ...props}) => <svg {...props} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>;
    const Layers = ({size = 24, ...props}) => <svg {...props} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>;

    const HydroBuild = () => {
      // State
      const [activeStep, setActiveStep] = useState('welcome'); // welcome, setup, design, zones, review
      const [projects, setProjects] = useState([]);
      const [currentProject, setCurrentProject] = useState(null);
      
      // Canvas
      const canvasRef = useRef(null);
      const [canvasSize, setCanvasSize] = useState({ width: 1000, height: 700 });
      
      // Design elements
      const [propertyBoundary, setPropertyBoundary] = useState([]);
      const [heads, setHeads] = useState([]);
      const [valves, setValves] = useState([]);
      const [pipes, setPipes] = useState([]);
      const [zones, setZones] = useState([]);
      
      // UI state
      const [selectedTool, setSelectedTool] = useState(null); // boundary, head, valve, move, delete
      const [selectedHeadType, setSelectedHeadType] = useState(null);
      const [drawingPoints, setDrawingPoints] = useState([]);
      const [draggedItem, setDraggedItem] = useState(null);
      const [hoveredItem, setHoveredItem] = useState(null);
      const [showPressure, setShowPressure] = useState(true);
      const [showCoverage, setShowCoverage] = useState(true);
      
      // Project settings
      const [settings, setSettings] = useState({
        address: '',
        psi: 60,
        gpm: 20,
        waterSource: 'city',
        elevation: 0,
        pipeType: 'PVC Schedule 40'
      });

      // Enhanced Equipment Database with real specs
      const equipmentDatabase = {
        sprays: [
          { id: 'hunter-pro-spray-4', brand: 'Hunter', model: 'Pro-Spray PRS40', type: 'spray', radius: 4, flow: 0.4, minPsi: 15, maxPsi: 30, pattern: 'Fixed', precipRate: 1.75 },
          { id: 'hunter-pro-spray-6', brand: 'Hunter', model: 'Pro-Spray PRS40', type: 'spray', radius: 6, flow: 0.65, minPsi: 15, maxPsi: 30, pattern: 'Fixed', precipRate: 1.75 },
          { id: 'hunter-pro-spray-8', brand: 'Hunter', model: 'Pro-Spray PRS40', type: 'spray', radius: 8, flow: 1.0, minPsi: 15, maxPsi: 30, pattern: 'Fixed', precipRate: 1.75 },
          { id: 'hunter-pro-spray-10', brand: 'Hunter', model: 'Pro-Spray PRS40', type: 'spray', radius: 10, flow: 1.3, minPsi: 15, maxPsi: 30, pattern: 'Fixed', precipRate: 1.75 },
          { id: 'hunter-pro-spray-12', brand: 'Hunter', model: 'Pro-Spray PRS40', type: 'spray', radius: 12, flow: 1.8, minPsi: 15, maxPsi: 30, pattern: 'Fixed', precipRate: 1.75 },
          { id: 'hunter-pro-spray-15', brand: 'Hunter', model: 'Pro-Spray PRS40', type: 'spray', radius: 15, flow: 2.4, minPsi: 15, maxPsi: 30, pattern: 'Fixed', precipRate: 1.75 },
          { id: 'rainbird-1804-4', brand: 'Rain Bird', model: '1804', type: 'spray', radius: 4, flow: 0.38, minPsi: 15, maxPsi: 30, pattern: 'Fixed', precipRate: 1.7 },
          { id: 'rainbird-1804-6', brand: 'Rain Bird', model: '1804', type: 'spray', radius: 6, flow: 0.7, minPsi: 20, maxPsi: 30, pattern: 'Fixed', precipRate: 1.7 },
          { id: 'rainbird-1804-8', brand: 'Rain Bird', model: '1804', type: 'spray', radius: 8, flow: 1.1, minPsi: 20, maxPsi: 30, pattern: 'Fixed', precipRate: 1.7 },
          { id: 'rainbird-1804-12', brand: 'Rain Bird', model: '1804', type: 'spray', radius: 12, flow: 1.9, minPsi: 25, maxPsi: 30, pattern: 'Fixed', precipRate: 1.7 },
          { id: 'rainbird-1804-15', brand: 'Rain Bird', model: '1804', type: 'spray', radius: 15, flow: 2.5, minPsi: 25, maxPsi: 30, pattern: 'Fixed', precipRate: 1.7 }
        ],
        rotors: [
          { id: 'hunter-pgp-ultra-18', brand: 'Hunter', model: 'PGP-Ultra', type: 'rotor', radius: 18, flow: 2.1, minPsi: 25, maxPsi: 70, pattern: 'Adjustable', precipRate: 0.6 },
          { id: 'hunter-pgp-ultra-25', brand: 'Hunter', model: 'PGP-Ultra', type: 'rotor', radius: 25, flow: 3.4, minPsi: 30, maxPsi: 70, pattern: 'Adjustable', precipRate: 0.6 },
          { id: 'hunter-pgp-ultra-30', brand: 'Hunter', model: 'PGP-Ultra', type: 'rotor', radius: 30, flow: 4.8, minPsi: 35, maxPsi: 70, pattern: 'Adjustable', precipRate: 0.6 },
          { id: 'hunter-pgp-ultra-35', brand: 'Hunter', model: 'PGP-Ultra', type: 'rotor', radius: 35, flow: 6.2, minPsi: 40, maxPsi: 70, pattern: 'Adjustable', precipRate: 0.6 },
          { id: 'rainbird-5004-20', brand: 'Rain Bird', model: '5004-PC', type: 'rotor', radius: 20, flow: 2.4, minPsi: 25, maxPsi: 70, pattern: 'Adjustable', precipRate: 0.5 },
          { id: 'rainbird-5004-25', brand: 'Rain Bird', model: '5004-PC', type: 'rotor', radius: 25, flow: 3.8, minPsi: 30, maxPsi: 70, pattern: 'Adjustable', precipRate: 0.5 },
          { id: 'rainbird-5004-30', brand: 'Rain Bird', model: '5004-PC', type: 'rotor', radius: 30, flow: 5.1, minPsi: 35, maxPsi: 70, pattern: 'Adjustable', precipRate: 0.5 },
          { id: 'rainbird-5004-35', brand: 'Rain Bird', model: '5004-PC', type: 'rotor', radius: 35, flow: 6.5, minPsi: 40, maxPsi: 70, pattern: 'Adjustable', precipRate: 0.5 },
          { id: 'toro-t5-20', brand: 'Toro', model: 'T5', type: 'rotor', radius: 20, flow: 2.2, minPsi: 25, maxPsi: 65, pattern: 'Adjustable', precipRate: 0.55 },
          { id: 'toro-t5-27', brand: 'Toro', model: 'T5', type: 'rotor', radius: 27, flow: 4.0, minPsi: 30, maxPsi: 65, pattern: 'Adjustable', precipRate: 0.55 }
        ],
        mpRotary: [
          { id: 'hunter-mp-1000-90', brand: 'Hunter', model: 'MP1000-90', type: 'mp-rotary', radius: 9, flow: 0.26, minPsi: 30, maxPsi: 45, pattern: '90°-210°', precipRate: 0.4 },
          { id: 'hunter-mp-2000-90', brand: 'Hunter', model: 'MP2000-90', type: 'mp-rotary', radius: 13, flow: 0.4, minPsi: 30, maxPsi: 45, pattern: '90°-210°', precipRate: 0.4 },
          { id: 'hunter-mp-3000-90', brand: 'Hunter', model: 'MP3000-90', type: 'mp-rotary', radius: 22, flow: 0.63, minPsi: 30, maxPsi: 45, pattern: '90°-210°', precipRate: 0.4 },
          { id: 'hunter-mp-3000-360', brand: 'Hunter', model: 'MP3000-360', type: 'mp-rotary', radius: 22, flow: 2.5, minPsi: 30, maxPsi: 45, pattern: '360°', precipRate: 0.4 },
          { id: 'rainbird-r-van-12', brand: 'Rain Bird', model: 'R-VAN-12', type: 'mp-rotary', radius: 8, flow: 0.3, minPsi: 25, maxPsi: 45, pattern: 'Adjustable', precipRate: 0.4 },
          { id: 'rainbird-r-van-18', brand: 'Rain Bird', model: 'R-VAN-18', type: 'mp-rotary', radius: 12, flow: 0.45, minPsi: 25, maxPsi: 45, pattern: 'Adjustable', precipRate: 0.4 },
          { id: 'rainbird-r-van-24', brand: 'Rain Bird', model: 'R-VAN-24', type: 'mp-rotary', radius: 18, flow: 0.72, minPsi: 25, maxPsi: 45, pattern: 'Adjustable', precipRate: 0.4 }
        ],
        bubblers: [
          { id: 'hunter-pcb-20', brand: 'Hunter', model: 'PCB-20', type: 'bubbler', radius: 2, flow: 0.5, minPsi: 15, maxPsi: 30, pattern: 'Bubbler', precipRate: 2.0 },
          { id: 'hunter-pcb-50', brand: 'Hunter', model: 'PCB-50', type: 'bubbler', radius: 2, flow: 1.0, minPsi: 15, maxPsi: 30, pattern: 'Bubbler', precipRate: 2.0 },
          { id: 'rainbird-bubbler', brand: 'Rain Bird', model: 'Bubbler', type: 'bubbler', radius: 2, flow: 0.75, minPsi: 15, maxPsi: 25, pattern: 'Bubbler', precipRate: 2.0 }
        ]
      };

      // Hydraulic calculation - Hazen-Williams formula
      const calculatePressureLoss = (flow, diameter, length, cFactor = 150) => {
        // Hazen-Williams: hf = (4.52 * L * Q^1.85) / (C^1.85 * D^4.87)
        // hf = head loss in feet, L = length in feet, Q = flow in GPM, C = roughness, D = diameter in inches
        const hf = (4.52 * length * Math.pow(flow, 1.85)) / (Math.pow(cFactor, 1.85) * Math.pow(diameter, 4.87));
        return hf * 0.433; // Convert feet of head to PSI
      };

      // Calculate velocity (should be < 5 fps)
      const calculateVelocity = (flow, diameter) => {
        // V = (0.408 * Q) / D^2
        // V in fps, Q in GPM, D in inches
        return (0.408 * flow) / Math.pow(diameter, 2);
      };

      // Pipe sizing options
      const pipeSizes = {
        '1/2"': { diameter: 0.622, maxFlow: 4 },
        '3/4"': { diameter: 0.824, maxFlow: 7 },
        '1"': { diameter: 1.049, maxFlow: 12 },
        '1-1/4"': { diameter: 1.380, maxFlow: 20 },
        '1-1/2"': { diameter: 1.610, maxFlow: 27 },
        '2"': { diameter: 2.067, maxFlow: 45 }
      };

      // Auto-size pipe based on flow
      const autosizePipe = (flow) => {
        for (let [size, specs] of Object.entries(pipeSizes)) {
          if (flow <= specs.maxFlow) return size;
        }
        return '2"';
      };

      // Calculate distance between points
      const distance = (p1, p2) => {
        return Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
      };

      // Initialize canvas
      useEffect(() => {
        if (canvasRef.current && activeStep === 'design') {
          const canvas = canvasRef.current;
          const container = canvas.parentElement;
          canvas.width = container.clientWidth;
          canvas.height = Math.min(700, window.innerHeight - 250);
          setCanvasSize({ width: canvas.width, height: canvas.height });
        }
      }, [activeStep]);

      // Redraw canvas
      useEffect(() => {
        if (canvasRef.current && activeStep === 'design') {
          drawCanvas();
        }
      }, [propertyBoundary, heads, valves, pipes, zones, drawingPoints, hoveredItem, showPressure, showCoverage, activeStep]);

      const drawCanvas = () => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        
        // Clear
        ctx.fillStyle = '#1a2f27';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Grid
        ctx.strokeStyle = 'rgba(255,255,255,0.05)';
        ctx.lineWidth = 1;
        for (let x = 0; x < canvas.width; x += 40) {
          ctx.beginPath();
          ctx.moveTo(x, 0);
          ctx.lineTo(x, canvas.height);
          ctx.stroke();
        }
        for (let y = 0; y < canvas.height; y += 40) {
          ctx.beginPath();
          ctx.moveTo(0, y);
          ctx.lineTo(canvas.width, y);
          ctx.stroke();
        }
        
        // Property boundary
        if (propertyBoundary.length > 2) {
          ctx.strokeStyle = '#00d9ff';
          ctx.lineWidth = 3;
          ctx.setLineDash([]);
          ctx.beginPath();
          ctx.moveTo(propertyBoundary[0].x, propertyBoundary[0].y);
          propertyBoundary.forEach(p => ctx.lineTo(p.x, p.y));
          ctx.closePath();
          ctx.stroke();
          
          ctx.fillStyle = 'rgba(0,217,255,0.08)';
          ctx.fill();
        }
        
        // Current drawing
        if (drawingPoints.length > 0) {
          ctx.strokeStyle = '#ffd700';
          ctx.lineWidth = 2;
          ctx.setLineDash([5, 5]);
          ctx.beginPath();
          ctx.moveTo(drawingPoints[0].x, drawingPoints[0].y);
          drawingPoints.forEach(p => ctx.lineTo(p.x, p.y));
          ctx.stroke();
          ctx.setLineDash([]);
          
          drawingPoints.forEach(p => {
            ctx.fillStyle = '#ffd700';
            ctx.beginPath();
            ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
            ctx.fill();
          });
        }
        
        // Pipes
        pipes.forEach(pipe => {
          const color = pipe.size === '1/2"' ? '#666' :
                       pipe.size === '3/4"' ? '#888' :
                       pipe.size === '1"' ? '#aaa' :
                       pipe.size === '1-1/4"' ? '#ccc' :
                       pipe.size === '1-1/2"' ? '#ddd' : '#fff';
          
          const width = pipe.size === '1/2"' ? 3 :
                       pipe.size === '3/4"' ? 4 :
                       pipe.size === '1"' ? 5 :
                       pipe.size === '1-1/4"' ? 6 :
                       pipe.size === '1-1/2"' ? 7 : 8;
          
          ctx.strokeStyle = color;
          ctx.lineWidth = width;
          ctx.setLineDash([]);
          ctx.beginPath();
          ctx.moveTo(pipe.from.x, pipe.from.y);
          ctx.lineTo(pipe.to.x, pipe.to.y);
          ctx.stroke();
          
          // Flow direction arrow
          const dx = pipe.to.x - pipe.from.x;
          const dy = pipe.to.y - pipe.from.y;
          const len = Math.sqrt(dx*dx + dy*dy);
          const midX = pipe.from.x + dx * 0.5;
          const midY = pipe.from.y + dy * 0.5;
          const angle = Math.atan2(dy, dx);
          
          ctx.save();
          ctx.translate(midX, midY);
          ctx.rotate(angle);
          ctx.fillStyle = '#00ff88';
          ctx.beginPath();
          ctx.moveTo(6, 0);
          ctx.lineTo(0, -4);
          ctx.lineTo(0, 4);
          ctx.closePath();
          ctx.fill();
          ctx.restore();
        });
        
        // Heads with coverage
        heads.forEach(head => {
          const headSpec = [...equipmentDatabase.sprays, ...equipmentDatabase.rotors, ...equipmentDatabase.mpRotary, ...equipmentDatabase.bubblers]
            .find(h => h.id === head.equipmentId);
          
          if (!headSpec) return;
          
          // Coverage circle
          if (showCoverage) {
            const radius = headSpec.radius * 4; // Scale
            
            // Pressure-based color
            let coverageColor = 'rgba(0,255,136,0.15)';
            if (showPressure && head.pressure) {
              if (head.pressure < headSpec.minPsi) coverageColor = 'rgba(255,0,0,0.2)';
              else if (head.pressure > headSpec.maxPsi) coverageColor = 'rgba(255,165,0,0.2)';
            }
            
            ctx.fillStyle = coverageColor;
            ctx.beginPath();
            ctx.arc(head.x, head.y, radius, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.strokeStyle = showPressure && head.pressure && head.pressure < headSpec.minPsi ? 'rgba(255,0,0,0.5)' :
                             showPressure && head.pressure && head.pressure > headSpec.maxPsi ? 'rgba(255,165,0,0.5)' :
                             'rgba(0,255,136,0.3)';
            ctx.lineWidth = 1.5;
            ctx.setLineDash([3, 3]);
            ctx.stroke();
            ctx.setLineDash([]);
          }
          
          // Head icon
          const typeColor = headSpec.type === 'spray' ? '#00d9ff' :
                           headSpec.type === 'rotor' ? '#9b59ff' :
                           headSpec.type === 'mp-rotary' ? '#00ff88' : '#ff9500';
          
          ctx.fillStyle = typeColor;
          ctx.beginPath();
          ctx.arc(head.x, head.y, 7, 0, Math.PI * 2);
          ctx.fill();
          
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 2;
          ctx.stroke();
          
          // Hover effect
          if (hoveredItem && hoveredItem.type === 'head' && hoveredItem.id === head.id) {
            ctx.strokeStyle = '#ffd700';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(head.x, head.y, 12, 0, Math.PI * 2);
            ctx.stroke();
          }
          
          // Zone number
          if (head.zoneId) {
            const zone = zones.find(z => z.id === head.zoneId);
            if (zone) {
              ctx.fillStyle = '#fff';
              ctx.font = 'bold 11px sans-serif';
              ctx.textAlign = 'center';
              ctx.fillText(zone.number, head.x, head.y - 14);
            }
          }
          
          // Pressure indicator
          if (showPressure && head.pressure) {
            ctx.fillStyle = head.pressure < headSpec.minPsi ? '#ff0000' :
                           head.pressure > headSpec.maxPsi ? '#ff9500' : '#00ff88';
            ctx.font = 'bold 9px monospace';
            ctx.textAlign = 'center';
            ctx.fillText(`${head.pressure.toFixed(0)}`, head.x, head.y + 20);
          }
        });
        
        // Valves
        valves.forEach(valve => {
          ctx.fillStyle = '#ff6b35';
          ctx.fillRect(valve.x - 9, valve.y - 9, 18, 18);
          
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 2;
          ctx.strokeRect(valve.x - 9, valve.y - 9, 18, 18);
          
          // Hover effect
          if (hoveredItem && hoveredItem.type === 'valve' && hoveredItem.id === valve.id) {
            ctx.strokeStyle = '#ffd700';
            ctx.lineWidth = 3;
            ctx.strokeRect(valve.x - 12, valve.y - 12, 24, 24);
          }
          
          // Zone label
          if (valve.zoneId) {
            const zone = zones.find(z => z.id === valve.zoneId);
            if (zone) {
              ctx.fillStyle = '#fff';
              ctx.font = 'bold 12px sans-serif';
              ctx.textAlign = 'center';
              ctx.fillText(`V${zone.number}`, valve.x, valve.y + 26);
            }
          }
        });
      };

      // Handle canvas interaction
      const handleCanvasClick = (e) => {
        if (!canvasRef.current) return;
        
        const rect = canvasRef.current.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        if (selectedTool === 'boundary') {
          setDrawingPoints([...drawingPoints, { x, y }]);
        } else if (selectedTool === 'head' && selectedHeadType) {
          const newHead = {
            id: `head-${Date.now()}`,
            equipmentId: selectedHeadType,
            x,
            y,
            zoneId: null,
            pressure: null
          };
          setHeads([...heads, newHead]);
        } else if (selectedTool === 'valve') {
          const newValve = {
            id: `valve-${Date.now()}`,
            x,
            y,
            zoneId: null
          };
          setValves([...valves, newValve]);
        } else if (selectedTool === 'delete') {
          // Delete item at click location
          const clickedHead = heads.find(h => distance(h, {x, y}) < 15);
          if (clickedHead) {
            setHeads(heads.filter(h => h.id !== clickedHead.id));
            return;
          }
          
          const clickedValve = valves.find(v => distance(v, {x, y}) < 15);
          if (clickedValve) {
            setValves(valves.filter(v => v.id !== clickedValve.id));
          }
        }
      };

      // Handle mouse move for drag and hover
      const handleCanvasMouseMove = (e) => {
        if (!canvasRef.current) return;
        
        const rect = canvasRef.current.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        // Check hover
        const hoveredHead = heads.find(h => distance(h, {x, y}) < 15);
        const hoveredValve = valves.find(v => distance(v, {x, y}) < 15);
        
        if (hoveredHead) {
          setHoveredItem({ type: 'head', id: hoveredHead.id });
        } else if (hoveredValve) {
          setHoveredItem({ type: 'valve', id: hoveredValve.id });
        } else {
          setHoveredItem(null);
        }
        
        // Handle drag
        if (draggedItem && selectedTool === 'move') {
          if (draggedItem.type === 'head') {
            setHeads(heads.map(h => h.id === draggedItem.id ? {...h, x, y} : h));
          } else if (draggedItem.type === 'valve') {
            setValves(valves.map(v => v.id === draggedItem.id ? {...v, x, y} : v));
          }
        }
      };

      const handleCanvasMouseDown = (e) => {
        if (selectedTool !== 'move') return;
        
        const rect = canvasRef.current.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        const clickedHead = heads.find(h => distance(h, {x, y}) < 15);
        if (clickedHead) {
          setDraggedItem({ type: 'head', id: clickedHead.id });
          return;
        }
        
        const clickedValve = valves.find(v => distance(v, {x, y}) < 15);
        if (clickedValve) {
          setDraggedItem({ type: 'valve', id: clickedValve.id });
        }
      };

      const handleCanvasMouseUp = () => {
        setDraggedItem(null);
      };

      // Finish drawing boundary
      const finishBoundary = () => {
        if (drawingPoints.length > 2) {
          setPropertyBoundary([...drawingPoints]);
          setDrawingPoints([]);
          setSelectedTool(null);
        }
      };

      // Smart auto-routing algorithm
      const generatePipeRouting = () => {
        if (heads.length === 0 || valves.length === 0 || zones.length === 0) return;
        
        const newPipes = [];
        
        zones.forEach(zone => {
          const zoneHeads = heads.filter(h => h.zoneId === zone.id);
          const zoneValve = valves.find(v => v.zoneId === zone.id);
          
          if (!zoneValve || zoneHeads.length === 0) return;
          
          // Calculate total zone flow
          let totalFlow = 0;
          zoneHeads.forEach(head => {
            const headSpec = [...equipmentDatabase.sprays, ...equipmentDatabase.rotors, ...equipmentDatabase.mpRotary, ...equipmentDatabase.bubblers]
              .find(h => h.id === head.equipmentId);
            if (headSpec) totalFlow += headSpec.flow;
          });
          
          // Create lateral lines (head to head)
          const sortedHeads = [...zoneHeads].sort((a, b) => {
            const distA = distance(a, zoneValve);
            const distB = distance(b, zoneValve);
            return distA - distB;
          });
          
          for (let i = 0; i < sortedHeads.length - 1; i++) {
            const lateralFlow = totalFlow * (sortedHeads.length - i) / sortedHeads.length;
            const lateralSize = autosizePipe(lateralFlow);
            
            newPipes.push({
              id: `pipe-${Date.now()}-${i}`,
              from: sortedHeads[i],
              to: sortedHeads[i + 1],
              size: lateralSize,
              type: 'lateral',
              flow: lateralFlow,
              zoneId: zone.id
            });
          }
          
          // Mainline from valve to first head
          if (sortedHeads.length > 0) {
            const mainlineSize = autosizePipe(totalFlow);
            newPipes.push({
              id: `pipe-main-${Date.now()}`,
              from: zoneValve,
              to: sortedHeads[0],
              size: mainlineSize,
              type: 'mainline',
              flow: totalFlow,
              zoneId: zone.id
            });
          }
        });
        
        setPipes(newPipes);
      };

      // Calculate hydraulics for all heads
      const calculateHydraulics = () => {
        const updatedHeads = heads.map(head => {
          // Find the pipe path from valve to this head
          const zone = zones.find(z => z.id === head.zoneId);
          if (!zone) return head;
          
          const valve = valves.find(v => v.zoneId === zone.id);
          if (!valve) return head;
          
          // Calculate pressure loss from valve to head
          let pressureLoss = 0;
          let currentPressure = settings.psi;
          
          // Find pipes in path (simplified - direct path)
          const headPipes = pipes.filter(p => p.zoneId === zone.id);
          headPipes.forEach(pipe => {
            const pipeLength = distance(pipe.from, pipe.to) / 4; // Scale to feet
            const pipeDiameter = pipeSizes[pipe.size]?.diameter || 1;
            const loss = calculatePressureLoss(pipe.flow, pipeDiameter, pipeLength);
            pressureLoss += loss;
          });
          
          const headPressure = currentPressure - pressureLoss - (settings.elevation * 0.433);
          
          return {
            ...head,
            pressure: Math.max(0, headPressure)
          };
        });
        
        setHeads(updatedHeads);
      };

      // Generate zones intelligently
      const generateZones = () => {
        if (heads.length === 0) return;
        
        const safeGpm = settings.gpm * 0.75; // 75% safety factor
        
        // Group by equipment type and precipitation rate
        const grouped = {};
        heads.forEach(head => {
          const headSpec = [...equipmentDatabase.sprays, ...equipmentDatabase.rotors, ...equipmentDatabase.mpRotary, ...equipmentDatabase.bubblers]
            .find(h => h.id === head.equipmentId);
          
          if (!headSpec) return;
          
          const key = `${headSpec.type}-${headSpec.precipRate}`;
          if (!grouped[key]) grouped[key] = [];
          grouped[key].push({ ...head, spec: headSpec });
        });
        
        // Create zones
        const newZones = [];
        let zoneCounter = 1;
        
        Object.values(grouped).forEach(group => {
          // Sort by proximity (cluster nearby heads)
          let remaining = [...group];
          
          while (remaining.length > 0) {
            let currentZone = {
              id: `zone-${Date.now()}-${zoneCounter}`,
              number: zoneCounter,
              heads: [],
              totalGpm: 0,
              warnings: []
            };
            
            // Start with first head
            let current = remaining[0];
            currentZone.heads.push(current.id);
            currentZone.totalGpm += current.spec.flow;
            remaining = remaining.slice(1);
            
            // Add nearby heads until GPM limit
            let added = true;
            while (added && remaining.length > 0) {
              added = false;
              
              // Find closest head that fits
              let bestIdx = -1;
              let bestDist = Infinity;
              
              for (let i = 0; i < remaining.length; i++) {
                const candidate = remaining[i];
                if (currentZone.totalGpm + candidate.spec.flow <= safeGpm) {
                  const dist = distance(current, candidate);
                  if (dist < bestDist) {
                    bestDist = dist;
                    bestIdx = i;
                  }
                }
              }
              
              if (bestIdx !== -1) {
                current = remaining[bestIdx];
                currentZone.heads.push(current.id);
                currentZone.totalGpm += current.spec.flow;
                remaining.splice(bestIdx, 1);
                added = true;
              }
            }
            
            // Check for warnings
            if (currentZone.totalGpm > safeGpm) {
              currentZone.warnings.push('Exceeds safe GPM');
            }
            
            newZones.push(currentZone);
            zoneCounter++;
          }
        });
        
        // Update heads with zone assignments
        const updatedHeads = heads.map(head => {
          const zone = newZones.find(z => z.heads.includes(head.id));
          return { ...head, zoneId: zone ? zone.id : null };
        });
        
        setHeads(updatedHeads);
        
        // Auto-assign valves to zones
        const updatedValves = [...valves];
        newZones.forEach(zone => {
          const zoneHeads = updatedHeads.filter(h => h.zoneId === zone.id);
          if (zoneHeads.length === 0) return;
          
          const centroidX = zoneHeads.reduce((sum, h) => sum + h.x, 0) / zoneHeads.length;
          const centroidY = zoneHeads.reduce((sum, h) => sum + h.y, 0) / zoneHeads.length;
          
          let nearestValve = null;
          let minDist = Infinity;
          
          updatedValves.forEach((valve, idx) => {
            if (valve.zoneId) return;
            const dist = distance(valve, { x: centroidX, y: centroidY });
            if (dist < minDist) {
              minDist = dist;
              nearestValve = idx;
            }
          });
          
          if (nearestValve !== null) {
            updatedValves[nearestValve] = { ...updatedValves[nearestValve], zoneId: zone.id };
          }
        });
        
        setValves(updatedValves);
        setZones(newZones);
        
        // Generate routing and calculate hydraulics
        setTimeout(() => {
          generatePipeRouting();
          setTimeout(() => calculateHydraulics(), 100);
        }, 100);
      };

      // Generate PDF quote
      const generatePDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Header
        doc.setFontSize(24);
        doc.setTextColor(255, 107, 53);
        doc.text('HydroBuild Pro', 20, 20);
        
        doc.setFontSize(16);
        doc.setTextColor(0, 0, 0);
        doc.text('Irrigation System Design & Quote', 20, 30);
        
        doc.setFontSize(10);
        doc.text(`Property: ${settings.address}`, 20, 40);
        doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 45);
        
        // System specs
        doc.setFontSize(14);
        doc.text('System Specifications', 20, 60);
        doc.setFontSize(10);
        doc.text(`Available Pressure: ${settings.psi} PSI`, 30, 68);
        doc.text(`Available Flow: ${settings.gpm} GPM`, 30, 73);
        doc.text(`Water Source: ${settings.waterSource}`, 30, 78);
        
        // Zone summary
        doc.setFontSize(14);
        doc.text('Zone Summary', 20, 93);
        doc.setFontSize(10);
        
        let y = 101;
        zones.forEach(zone => {
          const zoneHeads = heads.filter(h => h.zoneId === zone.id);
          doc.text(`Zone ${zone.number}: ${zoneHeads.length} heads, ${zone.totalGpm.toFixed(1)} GPM`, 30, y);
          y += 5;
          
          if (zone.warnings.length > 0) {
            doc.setTextColor(255, 0, 0);
            doc.text(`  ⚠ ${zone.warnings.join(', ')}`, 35, y);
            doc.setTextColor(0, 0, 0);
            y += 5;
          }
        });
        
        // Equipment list
        y += 10;
        doc.setFontSize(14);
        doc.text('Equipment List', 20, y);
        y += 8;
        doc.setFontSize(10);
        
        const equipmentCounts = {};
        heads.forEach(head => {
          const spec = [...equipmentDatabase.sprays, ...equipmentDatabase.rotors, ...equipmentDatabase.mpRotary, ...equipmentDatabase.bubblers]
            .find(h => h.id === head.equipmentId);
          if (spec) {
            const key = `${spec.brand} ${spec.model}`;
            equipmentCounts[key] = (equipmentCounts[key] || 0) + 1;
          }
        });
        
        Object.entries(equipmentCounts).forEach(([name, count]) => {
          doc.text(`${count}x ${name}`, 30, y);
          y += 5;
        });
        
        doc.text(`${valves.length}x Zone Valves`, 30, y);
        y += 5;
        
        // Pipe summary
        const pipeTotals = {};
        pipes.forEach(pipe => {
          const length = distance(pipe.from, pipe.to) / 4; // Scale to feet
          pipeTotals[pipe.size] = (pipeTotals[pipe.size] || 0) + length;
        });
        
        Object.entries(pipeTotals).forEach(([size, length]) => {
          doc.text(`${Math.round(length)} ft of ${size} PVC pipe`, 30, y);
          y += 5;
        });
        
        // Footer
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.text('Generated by HydroBuild Pro - Professional Irrigation Design Software', 20, 280);
        
        doc.save(`hydrobuild-${settings.address.replace(/\s/g, '-')}.pdf`);
      };

      // Welcome Screen
      const WelcomeScreen = () => (
        <div className="welcome-screen">
          <div className="welcome-hero">
            <div className="hero-icon">
              <Droplet size={80} />
            </div>
            <h1>HydroBuild Pro</h1>
            <p className="hero-tagline">Professional irrigation design made simple</p>
            <p className="hero-subtitle">Real hydraulic calculations • Smart auto-zoning • PDF quotes</p>
          </div>
          
          <div className="welcome-features">
            <div className="feature-card">
              <Zap size={32} />
              <h3>Smart Auto-Zone</h3>
              <p>Intelligent clustering with proximity and GPM optimization</p>
            </div>
            <div className="feature-card">
              <Activity size={32} />
              <h3>Real Hydraulics</h3>
              <p>Hazen-Williams pressure loss calculations</p>
            </div>
            <div className="feature-card">
              <Layers size={32} />
              <h3>Auto-Routing</h3>
              <p>Automatic pipe sizing and optimal path finding</p>
            </div>
            <div className="feature-card">
              <FileText size={32} />
              <h3>PDF Quotes</h3>
              <p>Professional branded estimates in seconds</p>
            </div>
          </div>
          
          <button className="btn-hero" onClick={() => setActiveStep('setup')}>
            Start New Design <ChevronRight size={24} />
          </button>
          
          <div className="welcome-footer">
            <p>Trusted by irrigation professionals worldwide</p>
          </div>
        </div>
      );

      // Setup Screen
      const SetupScreen = () => (
        <div className="setup-screen">
          <div className="setup-header">
            <button className="btn-back" onClick={() => setActiveStep('welcome')}>
              <ChevronLeft size={20} /> Back
            </button>
            <h2>Project Setup</h2>
            <div style={{width: 80}} />
          </div>
          
          <div className="setup-form">
            <div className="form-group">
              <label>Property Address</label>
              <input 
                type="text" 
                placeholder="123 Main St, City, State"
                value={settings.address}
                onChange={e => setSettings({...settings, address: e.target.value})}
              />
            </div>
            
            <div className="form-row">
              <div className="form-group">
                <label>Available PSI</label>
                <input 
                  type="number" 
                  value={settings.psi}
                  onChange={e => setSettings({...settings, psi: parseInt(e.target.value)})}
                />
                <span className="form-hint">Static water pressure</span>
              </div>
              
              <div className="form-group">
                <label>Available GPM</label>
                <input 
                  type="number" 
                  value={settings.gpm}
                  onChange={e => setSettings({...settings, gpm: parseInt(e.target.value)})}
                />
                <span className="form-hint">Maximum flow rate</span>
              </div>
            </div>
            
            <div className="form-group">
              <label>Water Source</label>
              <div className="radio-group">
                {['city', 'well', 'lake', 'pond'].map(source => (
                  <button
                    key={source}
                    className={`radio-btn ${settings.waterSource === source ? 'active' : ''}`}
                    onClick={() => setSettings({...settings, waterSource: source})}
                  >
                    {source}
                  </button>
                ))}
              </div>
            </div>
            
            <div className="form-group">
              <label>Elevation Change</label>
              <input 
                type="number" 
                value={settings.elevation}
                onChange={e => setSettings({...settings, elevation: parseInt(e.target.value)})}
              />
              <span className="form-hint">Feet (+ uphill, - downhill)</span>
            </div>
          </div>
          
          <button 
            className="btn-primary btn-large"
            disabled={!settings.address}
            onClick={() => setActiveStep('design')}
          >
            Continue to Design <ChevronRight size={20} />
          </button>
        </div>
      );

      // Design Screen
      const DesignScreen = () => (
        <div className="design-screen">
          <div className="design-header">
            <button className="btn-back" onClick={() => setActiveStep('setup')}>
              <ChevronLeft size={20} />
            </button>
            <h2>{settings.address}</h2>
            <button className="btn-next" onClick={() => setActiveStep('zones')}>
              Next <ChevronRight size={20} />
            </button>
          </div>
          
          <div className="design-toolbar">
            <div className="tool-section">
              <label>1. Draw Boundary</label>
              <button 
                className={`tool-btn ${selectedTool === 'boundary' ? 'active' : ''}`}
                onClick={() => {
                  setSelectedTool('boundary');
                  setDrawingPoints([]);
                }}
              >
                Draw Property
              </button>
              {drawingPoints.length > 2 && (
                <button className="btn-finish-small" onClick={finishBoundary}>
                  <Check size={16} /> Finish
                </button>
              )}
            </div>
            
            <div className="tool-section">
              <label>2. Place Equipment</label>
              <div className="equipment-tabs">
                <button 
                  className={`tab-btn ${selectedTool === 'head' ? 'active' : ''}`}
                  onClick={() => setSelectedTool('head')}
                >
                  Heads
                </button>
                <button 
                  className={`tab-btn ${selectedTool === 'valve' ? 'active' : ''}`}
                  onClick={() => setSelectedTool('valve')}
                >
                  Valves
                </button>
              </div>
            </div>
            
            <div className="tool-section">
              <label>3. Edit</label>
              <button 
                className={`tool-btn ${selectedTool === 'move' ? 'active' : ''}`}
                onClick={() => setSelectedTool('move')}
              >
                <Move size={16} /> Move
              </button>
              <button 
                className={`tool-btn ${selectedTool === 'delete' ? 'active' : ''}`}
                onClick={() => setSelectedTool('delete')}
              >
                <Trash size={16} /> Delete
              </button>
            </div>
            
            <div className="tool-section">
              <label>View</label>
              <button 
                className={`toggle-btn ${showCoverage ? 'active' : ''}`}
                onClick={() => setShowCoverage(!showCoverage)}
              >
                Coverage
              </button>
              <button 
                className={`toggle-btn ${showPressure ? 'active' : ''}`}
                onClick={() => setShowPressure(!showPressure)}
              >
                Pressure
              </button>
            </div>
          </div>
          
          {selectedTool === 'head' && (
            <div className="equipment-selector">
              <div className="equipment-category">
                <h4>Sprays</h4>
                <div className="equipment-grid">
                  {equipmentDatabase.sprays.slice(0, 6).map(head => (
                    <button
                      key={head.id}
                      className={`equipment-btn ${selectedHeadType === head.id ? 'active' : ''}`}
                      onClick={() => setSelectedHeadType(head.id)}
                    >
                      <div className="eq-brand">{head.brand}</div>
                      <div className="eq-model">{head.model}</div>
                      <div className="eq-specs">{head.radius}ft • {head.flow}gpm</div>
                    </button>
                  ))}
                </div>
              </div>
              
              <div className="equipment-category">
                <h4>Rotors</h4>
                <div className="equipment-grid">
                  {equipmentDatabase.rotors.slice(0, 6).map(head => (
                    <button
                      key={head.id}
                      className={`equipment-btn ${selectedHeadType === head.id ? 'active' : ''}`}
                      onClick={() => setSelectedHeadType(head.id)}
                    >
                      <div className="eq-brand">{head.brand}</div>
                      <div className="eq-model">{head.model}</div>
                      <div className="eq-specs">{head.radius}ft • {head.flow}gpm</div>
                    </button>
                  ))}
                </div>
              </div>
              
              <div className="equipment-category">
                <h4>MP Rotary</h4>
                <div className="equipment-grid">
                  {equipmentDatabase.mpRotary.slice(0, 4).map(head => (
                    <button
                      key={head.id}
                      className={`equipment-btn ${selectedHeadType === head.id ? 'active' : ''}`}
                      onClick={() => setSelectedHeadType(head.id)}
                    >
                      <div className="eq-brand">{head.brand}</div>
                      <div className="eq-model">{head.model}</div>
                      <div className="eq-specs">{head.radius}ft • {head.flow}gpm</div>
                    </button>
                  ))}
                </div>
              </div>
            </div>
          )}
          
          <div className="canvas-container">
            <canvas 
              ref={canvasRef}
              onClick={handleCanvasClick}
              onMouseMove={handleCanvasMouseMove}
              onMouseDown={handleCanvasMouseDown}
              onMouseUp={handleCanvasMouseUp}
              style={{ cursor: selectedTool === 'move' ? 'move' : selectedTool === 'delete' ? 'crosshair' : 'default' }}
            />
          </div>
          
          <div className="design-status">
            <div className="status-item">
              <strong>{heads.length}</strong> heads placed
            </div>
            <div className="status-item">
              <strong>{valves.length}</strong> valves placed
            </div>
            <div className="status-item">
              {propertyBoundary.length > 0 ? '✓ Boundary drawn' : 'Draw boundary to begin'}
            </div>
          </div>
        </div>
      );

      // Zones Screen
      const ZonesScreen = () => (
        <div className="zones-screen">
          <div className="zones-header">
            <button className="btn-back" onClick={() => setActiveStep('design')}>
              <ChevronLeft size={20} />
            </button>
            <h2>Auto-Zone System</h2>
            <button className="btn-next" onClick={() => setActiveStep('review')}>
              Review <ChevronRight size={20} />
            </button>
          </div>
          
          <div className="zones-content">
            {zones.length === 0 ? (
              <div className="zones-empty">
                <div className="empty-card">
                  <Zap size={48} />
                  <h3>Ready to Generate Zones</h3>
                  <p>{heads.length} heads • {valves.length} valves • {settings.gpm} GPM available</p>
                  <p className="safety-note">Using 75% safety factor: {(settings.gpm * 0.75).toFixed(1)} GPM per zone max</p>
                  
                  {heads.length === 0 && (
                    <div className="warning-box">
                      <AlertCircle size={20} />
                      <span>Add some heads first</span>
                    </div>
                  )}
                  
                  {valves.length === 0 && heads.length > 0 && (
                    <div className="warning-box">
                      <AlertCircle size={20} />
                      <span>Add valves before generating zones</span>
                    </div>
                  )}
                </div>
                
                <button 
                  className="btn-primary btn-large"
                  onClick={generateZones}
                  disabled={heads.length === 0 || valves.length === 0}
                >
                  <Zap size={20} />
                  Generate Zones
                </button>
              </div>
            ) : (
              <>
                <div className="zones-summary">
                  <h3>{zones.length} Zones Created</h3>
                  <p>Optimized for pressure, flow, and proximity</p>
                  
                  {zones.some(z => z.warnings.length > 0) && (
                    <div className="warning-box">
                      <AlertCircle size={20} />
                      <span>Some zones have warnings - review below</span>
                    </div>
                  )}
                </div>
                
                <div className="zones-list">
                  {zones.map(zone => {
                    const zoneHeads = heads.filter(h => h.zoneId === zone.id);
                    const zoneValve = valves.find(v => v.zoneId === zone.id);
                    
                    return (
                      <div key={zone.id} className="zone-card">
                        <div className="zone-header">
                          <h4>Zone {zone.number}</h4>
                          <span className="zone-gpm">{zone.totalGpm.toFixed(1)} GPM</span>
                        </div>
                        <div className="zone-body">
                          <div className="zone-stat">
                            <span>{zoneHeads.length} heads</span>
                          </div>
                          <div className="zone-stat">
                            <span>{zoneValve ? '✓ Valve assigned' : '⚠ No valve'}</span>
                          </div>
                          <div className="zone-stat">
                            <span>{zone.totalGpm <= settings.gpm * 0.75 ? '✓' : '⚠'} Flow OK</span>
                          </div>
                        </div>
                        {zone.warnings.length > 0 && (
                          <div className="zone-warnings">
                            {zone.warnings.map((w, i) => (
                              <div key={i} className="warning-tag">
                                <AlertCircle size={14} />
                                {w}
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
                
                <canvas ref={canvasRef} className="zone-preview" />
                
                <button className="btn-secondary" onClick={generateZones}>
                  Regenerate Zones
                </button>
              </>
            )}
          </div>
        </div>
      );

      // Review Screen
      const ReviewScreen = () => {
        const totalPipeLength = pipes.reduce((sum, pipe) => {
          return sum + (distance(pipe.from, pipe.to) / 4);
        }, 0);
        
        const equipmentCounts = {};
        heads.forEach(head => {
          const spec = [...equipmentDatabase.sprays, ...equipmentDatabase.rotors, ...equipmentDatabase.mpRotary, ...equipmentDatabase.bubblers]
            .find(h => h.id === head.equipmentId);
          if (spec) {
            const key = `${spec.brand} ${spec.model}`;
            equipmentCounts[key] = (equipmentCounts[key] || 0) + 1;
          }
        });
        
        return (
          <div className="review-screen">
            <div className="review-header">
              <button className="btn-back" onClick={() => setActiveStep('zones')}>
                <ChevronLeft size={20} />
              </button>
              <h2>System Review</h2>
              <button className="btn-pdf" onClick={generatePDF}>
                <Download size={20} /> PDF Quote
              </button>
            </div>
            
            <div className="review-content">
              <div className="review-section">
                <h3>System Overview</h3>
                <div className="stats-grid">
                  <div className="stat-box">
                    <div className="stat-value">{zones.length}</div>
                    <div className="stat-label">Zones</div>
                  </div>
                  <div className="stat-box">
                    <div className="stat-value">{heads.length}</div>
                    <div className="stat-label">Heads</div>
                  </div>
                  <div className="stat-box">
                    <div className="stat-value">{valves.length}</div>
                    <div className="stat-label">Valves</div>
                  </div>
                  <div className="stat-box">
                    <div className="stat-value">{Math.round(totalPipeLength)}</div>
                    <div className="stat-label">Feet of Pipe</div>
                  </div>
                </div>
              </div>
              
              <div className="review-section">
                <h3>Equipment List</h3>
                <div className="equipment-list">
                  {Object.entries(equipmentCounts).map(([name, count]) => (
                    <div key={name} className="equipment-row">
                      <span className="eq-count">{count}×</span>
                      <span className="eq-name">{name}</span>
                    </div>
                  ))}
                  <div className="equipment-row">
                    <span className="eq-count">{valves.length}×</span>
                    <span className="eq-name">Zone Valves</span>
                  </div>
                </div>
              </div>
              
              <div className="review-section">
                <h3>Zone Details</h3>
                <div className="zone-table">
                  {zones.map(zone => (
                    <div key={zone.id} className="zone-row">
                      <div className="zone-num">Zone {zone.number}</div>
                      <div className="zone-info">
                        <span>{zone.heads.length} heads</span>
                        <span>{zone.totalGpm.toFixed(1)} GPM</span>
                        <span>{zone.warnings.length === 0 ? '✓ OK' : `⚠ ${zone.warnings.length} warnings`}</span>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
              
              <canvas ref={canvasRef} className="review-canvas" />
            </div>
            
            <div className="review-actions">
              <button className="btn-primary btn-large" onClick={generatePDF}>
                <Download size={20} />
                Download PDF Quote
              </button>
            </div>
          </div>
        );
      };

      return (
        <div className="hydrobuild-app">
          <style>{`
            .hydrobuild-app {
              min-height: 100vh;
              background: linear-gradient(135deg, #0a1f1a 0%, #051209 100%);
            }
            
            .welcome-screen {
              max-width: 1200px;
              margin: 0 auto;
              padding: 60px 20px;
              text-align: center;
            }
            
            .welcome-hero {
              margin-bottom: 60px;
            }
            
            .hero-icon {
              color: #00ff88;
              margin-bottom: 20px;
            }
            
            .welcome-hero h1 {
              font-size: 56px;
              font-weight: 900;
              color: #00ff88;
              margin-bottom: 16px;
              letter-spacing: -1px;
            }
            
            .hero-tagline {
              font-size: 24px;
              color: #e0e0e0;
              margin-bottom: 12px;
            }
            
            .hero-subtitle {
              font-size: 16px;
              color: #888;
            }
            
            .welcome-features {
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
              gap: 30px;
              margin-bottom: 60px;
            }
            
            .feature-card {
              background: rgba(0,255,136,0.05);
              border: 2px solid rgba(0,255,136,0.2);
              border-radius: 16px;
              padding: 30px;
              transition: all 0.3s;
            }
            
            .feature-card:hover {
              border-color: #00ff88;
              transform: translateY(-4px);
              box-shadow: 0 8px 24px rgba(0,255,136,0.2);
            }
            
            .feature-card svg {
              color: #00ff88;
              margin-bottom: 16px;
            }
            
            .feature-card h3 {
              font-size: 20px;
              color: #fff;
              margin-bottom: 12px;
            }
            
            .feature-card p {
              color: #aaa;
              font-size: 14px;
              line-height: 1.6;
            }
            
            .btn-hero {
              background: #00ff88;
              color: #0a1612;
              border: none;
              padding: 20px 40px;
              font-size: 18px;
              font-weight: 700;
              border-radius: 12px;
              cursor: pointer;
              display: inline-flex;
              align-items: center;
              gap: 12px;
              transition: all 0.2s;
            }
            
            .btn-hero:hover {
              background: #00d970;
              transform: translateY(-2px);
              box-shadow: 0 8px 24px rgba(0,255,136,0.4);
            }
            
            .welcome-footer {
              margin-top: 60px;
              color: #666;
              font-size: 14px;
            }
            
            .setup-screen, .design-screen, .zones-screen, .review-screen {
              max-width: 1400px;
              margin: 0 auto;
              padding: 20px;
            }
            
            .setup-header, .design-header, .zones-header, .review-header {
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 20px 0;
              margin-bottom: 30px;
              border-bottom: 2px solid rgba(0,255,136,0.2);
            }
            
            .setup-header h2, .design-header h2, .zones-header h2, .review-header h2 {
              font-size: 28px;
              color: #00ff88;
              font-weight: 700;
            }
            
            .btn-back {
              background: transparent;
              border: 2px solid rgba(255,255,255,0.2);
              color: #fff;
              padding: 10px 20px;
              border-radius: 8px;
              cursor: pointer;
              display: flex;
              align-items: center;
              gap: 8px;
              transition: all 0.2s;
            }
            
            .btn-back:hover {
              border-color: #00ff88;
              color: #00ff88;
            }
            
            .btn-next, .btn-pdf {
              background: #00ff88;
              color: #0a1612;
              border: none;
              padding: 10px 20px;
              border-radius: 8px;
              font-weight: 600;
              cursor: pointer;
              display: flex;
              align-items: center;
              gap: 8px;
              transition: all 0.2s;
            }
            
            .btn-next:hover, .btn-pdf:hover {
              background: #00d970;
              transform: translateY(-2px);
            }
            
            .setup-form {
              max-width: 600px;
              margin: 0 auto 40px;
            }
            
            .form-group {
              margin-bottom: 24px;
            }
            
            .form-group label {
              display: block;
              font-size: 14px;
              font-weight: 600;
              color: #00ff88;
              margin-bottom: 8px;
              text-transform: uppercase;
              letter-spacing: 0.5px;
            }
            
            .form-group input {
              width: 100%;
              padding: 14px;
              background: rgba(0,255,136,0.05);
              border: 2px solid rgba(0,255,136,0.2);
              border-radius: 8px;
              color: #fff;
              font-size: 16px;
            }
            
            .form-group input:focus {
              outline: none;
              border-color: #00ff88;
            }
            
            .form-hint {
              display: block;
              margin-top: 6px;
              font-size: 12px;
              color: #888;
            }
            
            .form-row {
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 20px;
            }
            
            .radio-group {
              display: flex;
              gap: 12px;
            }
            
            .radio-btn {
              flex: 1;
              padding: 12px;
              background: rgba(0,255,136,0.05);
              border: 2px solid rgba(0,255,136,0.2);
              border-radius: 8px;
              color: #aaa;
              font-weight: 600;
              text-transform: uppercase;
              cursor: pointer;
              transition: all 0.2s;
            }
            
            .radio-btn:hover {
              border-color: #00ff88;
              color: #00ff88;
            }
            
            .radio-btn.active {
              background: #00ff88;
              color: #0a1612;
              border-color: #00ff88;
            }
            
            .btn-primary {
              width: 100%;
              padding: 16px;
              background: #00ff88;
              color: #0a1612;
              border: none;
              border-radius: 8px;
              font-size: 16px;
              font-weight: 700;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 10px;
              transition: all 0.2s;
            }
            
            .btn-primary:hover:not(:disabled) {
              background: #00d970;
              transform: translateY(-2px);
            }
            
            .btn-primary:disabled {
              background: #333;
              color: #666;
              cursor: not-allowed;
            }
            
            .btn-primary.btn-large {
              padding: 20px;
              font-size: 18px;
            }
            
            .btn-secondary {
              width: 100%;
              padding: 14px;
              background: transparent;
              color: #00ff88;
              border: 2px solid #00ff88;
              border-radius: 8px;
              font-size: 14px;
              font-weight: 700;
              cursor: pointer;
              transition: all 0.2s;
            }
            
            .btn-secondary:hover {
              background: rgba(0,255,136,0.1);
            }
            
            .design-toolbar {
              display: flex;
              gap: 20px;
              padding: 20px;
              background: rgba(0,255,136,0.05);
              border: 2px solid rgba(0,255,136,0.2);
              border-radius: 12px;
              margin-bottom: 20px;
              flex-wrap: wrap;
            }
            
            .tool-section {
              display: flex;
              flex-direction: column;
              gap: 8px;
            }
            
            .tool-section label {
              font-size: 11px;
              color: #888;
              text-transform: uppercase;
              letter-spacing: 0.5px;
            }
            
            .tool-btn {
              padding: 10px 16px;
              background: rgba(0,255,136,0.1);
              border: 2px solid rgba(0,255,136,0.3);
              border-radius: 6px;
              color: #aaa;
              font-weight: 600;
              cursor: pointer;
              display: flex;
              align-items: center;
              gap: 6px;
              transition: all 0.2s;
              font-size: 13px;
            }
            
            .tool-btn:hover {
              border-color: #00ff88;
              color: #00ff88;
            }
            
            .tool-btn.active {
              background: #00ff88;
              color: #0a1612;
              border-color: #00ff88;
            }
            
            .toggle-btn {
              padding: 8px 14px;
              background: rgba(0,255,136,0.1);
              border: 2px solid rgba(0,255,136,0.3);
              border-radius: 6px;
              color: #aaa;
              font-weight: 600;
              cursor: pointer;
              font-size: 12px;
              transition: all 0.2s;
            }
            
            .toggle-btn.active {
              background: rgba(0,255,136,0.2);
              border-color: #00ff88;
              color: #00ff88;
            }
            
            .btn-finish-small {
              padding: 8px 14px;
              background: #00ff88;
              color: #0a1612;
              border: none;
              border-radius: 6px;
              font-weight: 600;
              cursor: pointer;
              display: flex;
              align-items: center;
              gap: 6px;
              font-size: 12px;
            }
            
            .equipment-tabs {
              display: flex;
              gap: 8px;
            }
            
            .tab-btn {
              padding: 10px 16px;
              background: rgba(0,255,136,0.1);
              border: 2px solid rgba(0,255,136,0.3);
              border-radius: 6px;
              color: #aaa;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s;
              font-size: 13px;
            }
            
            .tab-btn.active {
              background: #00ff88;
              color: #0a1612;
              border-color: #00ff88;
            }
            
            .equipment-selector {
              padding: 20px;
              background: rgba(0,255,136,0.05);
              border: 2px solid rgba(0,255,136,0.2);
              border-radius: 12px;
              margin-bottom: 20px;
              max-height: 250px;
              overflow-y: auto;
            }
            
            .equipment-category {
              margin-bottom: 20px;
            }
            
            .equipment-category h4 {
              font-size: 12px;
              color: #00ff88;
              text-transform: uppercase;
              margin-bottom: 12px;
              letter-spacing: 0.5px;
            }
            
            .equipment-grid {
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
              gap: 10px;
            }
            
            .equipment-btn {
              padding: 12px;
              background: rgba(0,255,136,0.08);
              border: 2px solid rgba(0,255,136,0.3);
              border-radius: 8px;
              cursor: pointer;
              transition: all 0.2s;
              text-align: left;
            }
            
            .equipment-btn:hover {
              border-color: #00ff88;
            }
            
            .equipment-btn.active {
              background: #00ff88;
              border-color: #00ff88;
            }
            
            .eq-brand {
              font-size: 10px;
              color: #888;
              text-transform: uppercase;
              margin-bottom: 2px;
            }
            
            .equipment-btn.active .eq-brand {
              color: #0a1612;
            }
            
            .eq-model {
              font-size: 13px;
              font-weight: 600;
              color: #fff;
              margin-bottom: 4px;
            }
            
            .equipment-btn.active .eq-model {
              color: #0a1612;
            }
            
            .eq-specs {
              font-size: 11px;
              color: #aaa;
            }
            
            .equipment-btn.active .eq-specs {
              color: #0a1612;
              opacity: 0.7;
            }
            
            .canvas-container {
              position: relative;
              margin-bottom: 20px;
            }
            
            .canvas-container canvas {
              width: 100%;
              border: 2px solid rgba(0,255,136,0.2);
              border-radius: 12px;
            }
            
            .design-status {
              display: flex;
              gap: 30px;
              padding: 16px;
              background: rgba(0,255,136,0.05);
              border: 2px solid rgba(0,255,136,0.2);
              border-radius: 12px;
              font-size: 14px;
            }
            
            .status-item {
              color: #aaa;
            }
            
            .status-item strong {
              color: #00ff88;
              margin-right: 6px;
            }
            
            .zones-content {
              max-width: 900px;
              margin: 0 auto;
            }
            
            .zones-empty {
              text-align: center;
              padding: 60px 20px;
            }
            
            .empty-card {
              background: rgba(0,255,136,0.05);
              border: 2px solid rgba(0,255,136,0.2);
              border-radius: 16px;
              padding: 40px;
              margin-bottom: 30px;
            }
            
            .empty-card svg {
              color: #00ff88;
              margin-bottom: 20px;
            }
            
            .empty-card h3 {
              font-size: 24px;
              color: #fff;
              margin-bottom: 12px;
            }
            
            .empty-card p {
              color: #aaa;
              margin-bottom: 8px;
            }
            
            .safety-note {
              font-size: 13px;
              color: #888;
            }
            
            .warning-box {
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 8px;
              padding: 12px;
              background: rgba(255,165,0,0.1);
              border: 2px solid rgba(255,165,0,0.3);
              border-radius: 8px;
              color: #ffa500;
              margin-top: 20px;
              font-size: 14px;
            }
            
            .zones-summary {
              text-align: center;
              padding: 30px;
              background: rgba(0,255,136,0.05);
              border: 2px solid rgba(0,255,136,0.2);
              border-radius: 16px;
              margin-bottom: 30px;
            }
            
            .zones-summary h3 {
              font-size: 28px;
              color: #00ff88;
              margin-bottom: 8px;
            }
            
            .zones-list {
              display: flex;
              flex-direction: column;
              gap: 16px;
              margin-bottom: 30px;
            }
            
            .zone-card {
              background: rgba(0,255,136,0.05);
              border: 2px solid rgba(0,255,136,0.2);
              border-radius: 12px;
              padding: 20px;
            }
            
            .zone-header {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 12px;
            }
            
            .zone-header h4 {
              font-size: 18px;
              color: #fff;
            }
            
            .zone-gpm {
              font-size: 20px;
              font-weight: 700;
              color: #00ff88;
            }
            
            .zone-body {
              display: flex;
              gap: 20px;
              font-size: 13px;
              color: #aaa;
            }
            
            .zone-warnings {
              display: flex;
              gap: 10px;
              margin-top: 12px;
              flex-wrap: wrap;
            }
            
            .warning-tag {
              display: flex;
              align-items: center;
              gap: 6px;
              padding: 6px 12px;
              background: rgba(255,165,0,0.1);
              border: 1px solid rgba(255,165,0,0.3);
              border-radius: 6px;
              color: #ffa500;
              font-size: 12px;
            }
            
            .zone-preview {
              width: 100%;
              height: 400px !important;
              border: 2px solid rgba(0,255,136,0.2);
              border-radius: 12px;
              margin-bottom: 20px;
            }
            
            .review-content {
              max-width: 1000px;
              margin: 0 auto;
            }
            
            .review-section {
              margin-bottom: 40px;
            }
            
            .review-section h3 {
              font-size: 20px;
              color: #00ff88;
              margin-bottom: 20px;
              text-transform: uppercase;
              letter-spacing: 0.5px;
            }
            
            .stats-grid {
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
              gap: 20px;
            }
            
            .stat-box {
              background: rgba(0,255,136,0.05);
              border: 2px solid rgba(0,255,136,0.2);
              border-radius: 12px;
              padding: 24px;
              text-align: center;
            }
            
            .stat-value {
              font-size: 36px;
              font-weight: 700;
              color: #00ff88;
              margin-bottom: 8px;
            }
            
            .stat-label {
              font-size: 12px;
              color: #888;
              text-transform: uppercase;
            }
            
            .equipment-list {
              background: rgba(0,255,136,0.05);
              border: 2px solid rgba(0,255,136,0.2);
              border-radius: 12px;
              padding: 20px;
            }
            
            .equipment-row {
              display: flex;
              align-items: center;
              gap: 12px;
              padding: 12px 0;
              border-bottom: 1px solid rgba(0,255,136,0.1);
            }
            
            .equipment-row:last-child {
              border-bottom: none;
            }
            
            .eq-count {
              font-size: 16px;
              font-weight: 700;
              color: #00ff88;
              min-width: 40px;
            }
            
            .eq-name {
              color: #fff;
              font-size: 14px;
            }
            
            .zone-table {
              display: flex;
              flex-direction: column;
              gap: 12px;
            }
            
            .zone-row {
              display: flex;
              align-items: center;
              gap: 20px;
              padding: 16px;
              background: rgba(0,255,136,0.05);
              border: 2px solid rgba(0,255,136,0.2);
              border-radius: 8px;
            }
            
            .zone-num {
              font-size: 16px;
              font-weight: 700;
              color: #00ff88;
              min-width: 80px;
            }
            
            .zone-info {
              display: flex;
              gap: 20px;
              font-size: 13px;
              color: #aaa;
            }
            
            .review-canvas {
              width: 100%;
              height: 500px !important;
              border: 2px solid rgba(0,255,136,0.2);
              border-radius: 12px;
              margin-bottom: 30px;
            }
            
            .review-actions {
              max-width: 500px;
              margin: 0 auto;
            }
            
            @media (max-width: 768px) {
              .form-row {
                grid-template-columns: 1fr;
              }
              
              .stats-grid {
                grid-template-columns: 1fr 1fr;
              }
              
              .design-toolbar {
                flex-direction: column;
              }
            }
          `}</style>
          
          {activeStep === 'welcome' && <WelcomeScreen />}
          {activeStep === 'setup' && <SetupScreen />}
          {activeStep === 'design' && <DesignScreen />}
          {activeStep === 'zones' && <ZonesScreen />}
          {activeStep === 'review' && <ReviewScreen />}
        </div>
      );
    };

    ReactDOM.render(<HydroBuild />, document.getElementById('root'));
  </script>
</body>
</html>
