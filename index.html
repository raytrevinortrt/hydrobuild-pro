<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HydroBuild Pro - Fixed Version</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0a1f1a 0%, #051209 100%);
      color: #e0e0e0;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container { max-width: 1400px; margin: 0 auto; }
    
    h1 { color: #00ff88; font-size: 32px; margin-bottom: 20px; }
    
    .status-bar {
      background: rgba(0,255,136,0.1);
      border: 2px solid rgba(0,255,136,0.3);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 16px;
    }
    
    .status-bar strong { color: #00ff88; }
    
    .toolbar {
      background: rgba(0,255,136,0.05);
      border: 2px solid rgba(0,255,136,0.2);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    button {
      background: rgba(0,255,136,0.2);
      border: 2px solid rgba(0,255,136,0.4);
      color: #e0e0e0;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    button:hover {
      background: rgba(0,255,136,0.3);
      border-color: #00ff88;
      transform: translateY(-1px);
    }
    
    button.active {
      background: #00ff88;
      color: #0a1612;
      border-color: #00ff88;
    }
    
    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }
    
    #canvas {
      border: 3px solid rgba(0,255,136,0.4);
      border-radius: 8px;
      cursor: crosshair;
      display: block;
      width: 100%;
      background: #1a2f27;
      margin-bottom: 20px;
    }
    
    .equipment-panel {
      background: rgba(0,255,136,0.05);
      border: 2px solid rgba(0,255,136,0.2);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }
    
    .equipment-panel.show { display: block; }
    
    .equipment-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    
    .eq-btn {
      background: rgba(0,255,136,0.1);
      border: 2px solid rgba(0,255,136,0.3);
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
      text-align: left;
      transition: all 0.2s;
    }
    
    .eq-btn:hover { border-color: #00ff88; }
    .eq-btn.active { background: #00ff88; color: #0a1612; }
    
    .eq-name { font-weight: 600; font-size: 13px; margin-bottom: 4px; }
    .eq-specs { font-size: 11px; opacity: 0.8; }
    
    .stats {
      background: rgba(0,255,136,0.05);
      border: 2px solid rgba(0,255,136,0.2);
      padding: 15px;
      border-radius: 8px;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    
    .stat-box {
      background: rgba(0,255,136,0.1);
      padding: 15px;
      border-radius: 6px;
      min-width: 120px;
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #00ff88;
    }
    
    .stat-label {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 5px;
    }
    
    .message {
      padding: 12px;
      border-radius: 6px;
      margin: 10px 0;
      display: none;
    }
    
    .message.show { display: block; }
    .message.success {
      background: rgba(0,255,136,0.1);
      border: 2px solid rgba(0,255,136,0.3);
      color: #00ff88;
    }
    .message.alert {
      background: rgba(255,165,0,0.1);
      border: 2px solid rgba(255,165,0,0.3);
      color: #ffa500;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ’§ HydroBuild Pro</h1>
    
    <div class="status-bar">
      <strong>Current Step:</strong> <span id="current-step">Draw Property Boundary</span><br>
      <span id="instruction">Click on the canvas below to add boundary points. You need at least 3 points.</span>
    </div>
    
    <div class="toolbar">
      <button id="btn-draw-boundary" class="active">1. Draw Boundary</button>
      <button id="btn-finish-boundary" disabled>Finish Boundary</button>
      <button id="btn-place-heads" disabled>2. Place Heads</button>
      <button id="btn-place-valves" disabled>3. Place Valves</button>
      <button id="btn-generate-zones" disabled>4. Generate Zones</button>
      <button id="btn-clear-all">Clear All</button>
      <button id="btn-undo">Undo</button>
    </div>
    
    <div class="message" id="message"></div>
    
    <div class="equipment-panel" id="equipment-panel">
      <h3 style="color: #00ff88; margin-bottom: 10px;">Select Head Type</h3>
      <div class="equipment-grid" id="equipment-grid"></div>
    </div>
    
    <canvas id="canvas" width="1200" height="700"></canvas>
    
    <div class="stats">
      <div class="stat-box">
        <div class="stat-value" id="stat-boundary">0</div>
        <div class="stat-label">Boundary Points</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="stat-heads">0</div>
        <div class="stat-label">Heads Placed</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="stat-valves">0</div>
        <div class="stat-label">Valves Placed</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="stat-zones">0</div>
        <div class="stat-label">Zones Created</div>
      </div>
    </div>
  </div>

  <script>
    console.log('ðŸš€ HydroBuild starting...');
    
    // App state
    const app = {
      mode: 'boundary',
      boundaryPoints: [],
      heads: [],
      valves: [],
      zones: [],
      selectedHead: null,
      history: []
    };
    
    // Equipment database
    const equipment = {
      sprays: [
        { id: 's4', name: 'Spray 4ft', r: 4, gpm: 0.4, color: '#2196F3' },
        { id: 's6', name: 'Spray 6ft', r: 6, gpm: 0.65, color: '#2196F3' },
        { id: 's8', name: 'Spray 8ft', r: 8, gpm: 1.0, color: '#2196F3' },
        { id: 's10', name: 'Spray 10ft', r: 10, gpm: 1.3, color: '#2196F3' },
        { id: 's12', name: 'Spray 12ft', r: 12, gpm: 1.8, color: '#2196F3' },
        { id: 's15', name: 'Spray 15ft', r: 15, gpm: 2.4, color: '#2196F3' }
      ],
      rotors: [
        { id: 'r18', name: 'Rotor 18ft', r: 18, gpm: 2.1, color: '#9C27B0' },
        { id: 'r20', name: 'Rotor 20ft', r: 20, gpm: 2.4, color: '#9C27B0' },
        { id: 'r25', name: 'Rotor 25ft', r: 25, gpm: 4.0, color: '#9C27B0' },
        { id: 'r30', name: 'Rotor 30ft', r: 30, gpm: 4.8, color: '#9C27B0' },
        { id: 'r35', name: 'Rotor 35ft', r: 35, gpm: 6.5, color: '#9C27B0' }
      ],
      mp: [
        { id: 'm8', name: 'MP 8ft', r: 8, gpm: 0.26, color: '#009688' },
        { id: 'm10', name: 'MP 10ft', r: 10, gpm: 0.35, color: '#009688' },
        { id: 'm15', name: 'MP 15ft', r: 15, gpm: 0.8, color: '#009688' },
        { id: 'm20', name: 'MP 20ft', r: 20, gpm: 1.2, color: '#009688' }
      ],
      bubblers: [
        { id: 'b1', name: 'Bubbler 1', r: 2, gpm: 0.5, color: '#FF9800' },
        { id: 'b2', name: 'Bubbler 2', r: 2, gpm: 1.0, color: '#FF9800' },
        { id: 'b4', name: 'Bubbler 4', r: 3, gpm: 2.0, color: '#FF9800' }
      ],
      drip: [
        { id: 'd1', name: 'Drip 6"', r: 1, gpm: 0.5, color: '#795548' },
        { id: 'd2', name: 'Drip 12"', r: 1, gpm: 0.25, color: '#795548' }
      ]
    };
    
    const allEquipment = [...equipment.sprays, ...equipment.rotors, ...equipment.mp, ...equipment.bubblers, ...equipment.drip];
    
    // Canvas setup
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    console.log('âœ… Canvas ready:', canvas.width, 'x', canvas.height);
    
    // Draw function
    function draw() {
      // Clear
      ctx.fillStyle = '#1a2f27';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Grid
      ctx.strokeStyle = 'rgba(255,255,255,0.05)';
      ctx.lineWidth = 1;
      for (let x = 0; x < canvas.width; x += 50) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      }
      for (let y = 0; y < canvas.height; y += 50) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }
      
      // Boundary
      if (app.boundaryPoints.length > 0) {
        ctx.strokeStyle = '#00d9ff';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(app.boundaryPoints[0].x, app.boundaryPoints[0].y);
        app.boundaryPoints.forEach(p => ctx.lineTo(p.x, p.y));
        if (app.mode !== 'boundary') {
          ctx.closePath();
          ctx.fillStyle = 'rgba(0,217,255,0.1)';
          ctx.fill();
        }
        ctx.stroke();
        
        // Points
        app.boundaryPoints.forEach((p, i) => {
          ctx.fillStyle = '#00d9ff';
          ctx.beginPath();
          ctx.arc(p.x, p.y, 6, 0, Math.PI * 2);
          ctx.fill();
          
          ctx.fillStyle = '#fff';
          ctx.font = 'bold 12px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(i + 1, p.x, p.y - 12);
        });
      }
      
      // Heads
      app.heads.forEach(head => {
        const eq = allEquipment.find(e => e.id === head.type);
        if (!eq) return;
        
        // Coverage
        ctx.strokeStyle = eq.color + '80';
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 5]);
        ctx.beginPath();
        ctx.arc(head.x, head.y, eq.r * 3, 0, Math.PI * 2);
        ctx.stroke();
        ctx.setLineDash([]);
        
        // Head
        ctx.fillStyle = eq.color;
        ctx.beginPath();
        ctx.arc(head.x, head.y, 8, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.stroke();
      });
      
      // Valves
      app.valves.forEach(valve => {
        ctx.fillStyle = '#ff6b35';
        ctx.fillRect(valve.x - 10, valve.y - 10, 20, 20);
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.strokeRect(valve.x - 10, valve.y - 10, 20, 20);
      });
    }
    
    // Canvas click
    canvas.addEventListener('click', function(e) {
      console.log('ðŸ–±ï¸ Canvas clicked!');
      
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const x = (e.clientX - rect.left) * scaleX;
      const y = (e.clientY - rect.top) * scaleY;
      
      console.log('Position:', Math.round(x), Math.round(y));
      console.log('Mode:', app.mode);
      
      if (app.mode === 'boundary') {
        app.boundaryPoints.push({ x, y });
        console.log('âœ… Point added! Total:', app.boundaryPoints.length);
        updateStats();
        draw();
        
        if (app.boundaryPoints.length >= 3) {
          document.getElementById('btn-finish-boundary').disabled = false;
          showMessage('Great! You have ' + app.boundaryPoints.length + ' points. Click "Finish Boundary" when done.', 'success');
        }
      } else if (app.mode === 'head' && app.selectedHead) {
        app.heads.push({ x, y, type: app.selectedHead });
        console.log('âœ… Head placed!');
        updateStats();
        draw();
        showMessage('Head placed!', 'success');
      } else if (app.mode === 'valve') {
        app.valves.push({ x, y });
        console.log('âœ… Valve placed!');
        updateStats();
        draw();
        showMessage('Valve placed!', 'success');
      }
    });
    
    // Button: Draw Boundary
    document.getElementById('btn-draw-boundary').addEventListener('click', function() {
      app.mode = 'boundary';
      updateUI();
      showMessage('Click on canvas to add boundary points', 'success');
    });
    
    // Button: Finish Boundary
    document.getElementById('btn-finish-boundary').addEventListener('click', function() {
      if (app.boundaryPoints.length >= 3) {
        app.mode = 'head';
        document.getElementById('btn-place-heads').disabled = false;
        document.getElementById('btn-place-valves').disabled = false;
        updateUI();
        draw();
        showMessage('âœ“ Boundary complete! Now place irrigation heads.', 'success');
      }
    });
    
    // Button: Place Heads
    document.getElementById('btn-place-heads').addEventListener('click', function() {
      app.mode = 'head';
      updateUI();
      showMessage('Select a head type below, then click on canvas', 'success');
    });
    
    // Button: Place Valves
    document.getElementById('btn-place-valves').addEventListener('click', function() {
      app.mode = 'valve';
      updateUI();
      showMessage('Click on canvas to place valves', 'success');
    });
    
    // Button: Generate Zones
    document.getElementById('btn-generate-zones').addEventListener('click', function() {
      if (app.heads.length === 0) {
        showMessage('Place some heads first!', 'alert');
        return;
      }
      
      // Simple zoning
      const zones = Math.ceil(app.heads.length / 6);
      app.zones = new Array(zones).fill(0);
      
      document.getElementById('btn-generate-zones').disabled = false;
      updateStats();
      showMessage('âœ“ Created ' + zones + ' zones!', 'success');
    });
    
    // Button: Clear All
    document.getElementById('btn-clear-all').addEventListener('click', function() {
      if (confirm('Clear everything?')) {
        app.boundaryPoints = [];
        app.heads = [];
        app.valves = [];
        app.zones = [];
        app.mode = 'boundary';
        updateStats();
        updateUI();
        draw();
        showMessage('Cleared!', 'success');
      }
    });
    
    // Button: Undo
    document.getElementById('btn-undo').addEventListener('click', function() {
      if (app.mode === 'boundary' && app.boundaryPoints.length > 0) {
        app.boundaryPoints.pop();
      } else if (app.mode === 'head' && app.heads.length > 0) {
        app.heads.pop();
      } else if (app.mode === 'valve' && app.valves.length > 0) {
        app.valves.pop();
      }
      updateStats();
      draw();
      showMessage('Undone!', 'success');
    });
    
    // Update UI
    function updateUI() {
      // Clear active buttons
      document.querySelectorAll('.toolbar button').forEach(b => b.classList.remove('active'));
      
      if (app.mode === 'boundary') {
        document.getElementById('btn-draw-boundary').classList.add('active');
        document.getElementById('equipment-panel').classList.remove('show');
        document.getElementById('current-step').textContent = 'Draw Property Boundary';
        document.getElementById('instruction').textContent = 'Click on the canvas to add points. Need at least 3 points.';
      } else if (app.mode === 'head') {
        document.getElementById('btn-place-heads').classList.add('active');
        document.getElementById('equipment-panel').classList.add('show');
        populateEquipment();
        document.getElementById('current-step').textContent = 'Place Irrigation Heads';
        document.getElementById('instruction').textContent = 'Select a head type below, then click on canvas to place it.';
      } else if (app.mode === 'valve') {
        document.getElementById('btn-place-valves').classList.add('active');
        document.getElementById('equipment-panel').classList.remove('show');
        document.getElementById('current-step').textContent = 'Place Zone Valves';
        document.getElementById('instruction').textContent = 'Click on canvas to place valve boxes.';
      }
    }
    
    // Populate equipment
    function populateEquipment() {
      const grid = document.getElementById('equipment-grid');
      grid.innerHTML = '';
      
      const categories = [
        { name: 'ðŸ’§ Sprays', items: equipment.sprays },
        { name: 'ðŸŒ€ Rotors', items: equipment.rotors },
        { name: 'âš¡ MP Rotary', items: equipment.mp },
        { name: 'ðŸ’¦ Bubblers', items: equipment.bubblers },
        { name: 'ðŸ’§ Drip', items: equipment.drip }
      ];
      
      categories.forEach(cat => {
        const header = document.createElement('div');
        header.style.gridColumn = '1 / -1';
        header.style.color = '#00ff88';
        header.style.fontWeight = 'bold';
        header.style.marginTop = '10px';
        header.textContent = cat.name;
        grid.appendChild(header);
        
        cat.items.forEach(eq => {
          const btn = document.createElement('button');
          btn.className = 'eq-btn';
          if (app.selectedHead === eq.id) btn.classList.add('active');
          btn.innerHTML = `<div class="eq-name">${eq.name}</div><div class="eq-specs">${eq.r}ft â€¢ ${eq.gpm}gpm</div>`;
          btn.onclick = function() {
            app.selectedHead = eq.id;
            populateEquipment();
            showMessage('Selected: ' + eq.name, 'success');
          };
          grid.appendChild(btn);
        });
      });
    }
    
    // Update stats
    function updateStats() {
      document.getElementById('stat-boundary').textContent = app.boundaryPoints.length;
      document.getElementById('stat-heads').textContent = app.heads.length;
      document.getElementById('stat-valves').textContent = app.valves.length;
      document.getElementById('stat-zones').textContent = app.zones.length;
      
      if (app.heads.length > 0 && app.valves.length > 0) {
        document.getElementById('btn-generate-zones').disabled = false;
      }
    }
    
    // Show message
    function showMessage(text, type) {
      const msg = document.getElementById('message');
      msg.textContent = text;
      msg.className = 'message show ' + type;
      setTimeout(() => msg.classList.remove('show'), 5000);
    }
    
    // Initialize
    console.log('âœ… HydroBuild ready!');
    draw();
    updateUI();
    showMessage('Welcome! Click on canvas to start drawing your property boundary.', 'success');
  </script>
</body>
</html>
